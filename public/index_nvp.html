<!DOCTYPE html>
<html>

<head>
    <title>Smart Buttons - Payments SDK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>

    <!-- Payment SDK -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AYidKuTmO-c-5kUElRNtNin579BxO3G6dzYK9rLuY0AUp01QY67KZTRXWedVDAHYdhE7IvgPuWDtBqfq&currency=USD&intent=order"></script>
    <style>
        pre {
            font-size: 80%;
        }
    </style>
</head>

<body>

    <!-- BEGIN: STEP HEADER -->
    <div class="ui menu">
        <a class="active item" id="home">
            <i class="home icon"></i> Home
        </a>
    </div>
    <div class="ui four top attached mini steps">
        <div class="active step" id="stepOne">
            <i class="angle double right icon"></i>
            <div class="content">
                <div class="title">Approve</div>
            </div>
        </div>
        <div class="disabled step" id="stepTwo">
            <i class="angle double right icon"></i>
            <div class="content">
                <div class="title">Review</div>
            </div>
        </div>
        <div class="disabled step" id="stepThree">
            <i class="angle double right icon"></i>
            <div class="content">
                <div class="title">Capture</div>
            </div>
        </div>
        <div class="disabled step" id="stepFour">
                <i class="angle double right icon"></i>
                <div class="content">
                    <div class="title">Complete</div>
                </div>
            </div>
    </div>
    <!-- END: STEP HEADER -->

    <!-- BEGIN: MAIN CONTENT -->
    <div class="ui dimmable attached segment" id="mainSection">
        <p>
        <p>
        <div class="ui grid">
            
            <div class="row">
                <div class="column">
                    <h3 class="ui header">Payments SDK - Sample Test</h3>
                </div>
            </div>
            
            <div class="row">
                <div class="column">

                    <!-- PAYMENT FORM -->
                    <div class="ui form" id="paymentForm">
                        <div class="ui stackable internally celled grid">
                            <div class="four wide column">
                                <div id="paypal-button-container"></div>
                            </div>
                            <div class="eight wide column" id="paymentData">
                                <h4 class="ui header">Payment Data</h4>
                                <p></p>
                                <p></p>
                            </div>
                        </div>
                    </div>

                    <!-- ORDER REVIEW FORM -->
                    <div class="ui form" id="authForm" hidden>
                        <div class="ui stackable internally celled grid">
                            <div class="four wide column">
                                <input type="hidden" id="token" />
                                <input type="hidden" id="payerId" />
                                <button class="ui primary button" id="authorize">
                                    DoEC/DoAuth
                                </button>
                                <button class="ui button" id="cancel">
                                    Discard
                                </button>
                            </div>
                            <div class="eight wide column" id="orderData">
                                <h4 class="ui header">Order Data</h4>
                                <p></p>
                                <p></p>
                            </div>
                        </div>
                    </div>

                    <!-- AUTH REVIEW FORM -->
                    <div class="ui form" id="captureForm" hidden>
                        <div class="ui stackable internally celled grid">
                            <div class="four wide column">
                                <input type="hidden" id="authId" />
                                <button class="ui primary button" id="capture">
                                    Capture
                                </button>
                                <button class="ui button" id="cancel">
                                    Discard
                                </button>
                            </div>
                            <div class="eight wide column" id="authData">
                                <h4 class="ui header">Authorization Data</h4>
                                <p></p>
                                <p></p>
                            </div>
                        </div>
                    </div>

                    <!-- CAPTURE REVIEW FORM -->
                    <div class="ui form" id="finalForm" hidden>
                        <div class="ui stackable internally celled grid">
                            <div class="four wide column">
                                <button class="ui primary button" id="cancel">
                                    Do it Again
                                </button>
                            </div>
                            <div class="eight wide column" id="captureData">
                                <h4 class="ui header">Capture Data</h4>
                                <p></p>
                                <p></p>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
    <!-- END: MAIN CONTENT -->

    <script>

        // set the text area with payment data
        $("#paymentData").append("<pre>" + JSON.stringify(paymentData, null, 1) + "</pre>");

        paypal.Buttons({
            style: {
                // height: 25
            },

            createOrder: function (data, actions) {

                // CLIENT SIDE ORDER CREATE
                return fetch('/nvp/setEC', {
                    method: 'POST',
                    body: '{}',
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(function(response){
                    return response.json();
                })
                .then(function (json) {
                    return json.TOKEN;
                }, function (error) {
                    console.error("error.message: ", error.message) //=> String
                });
            },
            onApprove: function (data, actions) {

                const orderId = data.orderID;
                console.log("onApprove data: ", data);
                return fetch(`/nvp/getEC/${orderId}`, {
                    method: 'GET',
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(function (response) {
                    return response.json();
                }).then(function (getEcResp) {
                    console.log("getEcResp Data: ", getEcResp);

                    // show the order data
                    $("#orderData").append("<pre>" + JSON.stringify(getEcResp, null, 2) + "</pre>");
                    $("#token").val(getEcResp.TOKEN);
                    $("#payerId").val(getEcResp.PAYERID);

                    // show or hide forms
                    $("#paymentForm").hide();
                    $("#authForm").show();

                    // update the "steps"
                    $("#stepOne").addClass("disabled").removeClass("active");
                    $("#stepTwo").addClass("active").removeClass("disabled");

                    // handle the authorization click
                    $("#authorize").click(function () {
                        console.log("Authorizing the order: ", orderId);

                        // show the dimmer / loader
                        $("#mainSection").dimmer("show");

                        fetch(`/nvp/doCombined`, {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                token: $("#token").val(),
                                payerId: $("#payerId").val()
                            })
                        }).then(function (response) {
                            return response.json();
                        }).then(function (auth) {
                            console.log("Authorization data: ", auth);
                            // var authId = auth.id;
                            var authId = 999;

                            // show the authorization data
                            $("#authData").append("<pre>" + JSON.stringify(auth, null, 2) + "</pre>");
                            $("#authId").val(authId);

                            // show or hide forms 
                            $("#authForm").hide();
                            $("#captureForm").show();

                            // update the "steps"
                            $("#stepTwo").addClass("disabled").removeClass("active");
                            $("#stepThree").addClass("active").removeClass("disabled");

                            $("#mainSection").dimmer("hide");

                            $("#capture").click(function () {
                                console.log("Capturing the auth: ", authId);

                                // show the dimmer / loader
                                $("#mainSection").dimmer("show");

                                fetch(`/nvp/doAuth${authId}/capture`, {
                                    method: 'POST',
                                    headers: {
                                        "Content-Type": "application/json"
                                    }
                                }).then(function (response) {
                                    return response.json();
                                }).then(function (capture) {
                                    // show the authorization data
                                    $("#captureData").append("<pre>" + JSON.stringify(capture, null, 2) + "</pre>");

                                    // show or hide forms 
                                    $("#captureForm").hide();
                                    $("#finalForm").show();

                                    // update the "steps"
                                    $("#stepThree").addClass("disabled").removeClass("active");
                                    $("#stepFour").addClass("active").removeClass("disabled");

                                    $("#mainSection").dimmer("hide");

                                }), function (error) {
                                    $("#mainSection").dimmer("hide");
                                    console.log("ERROR in catch: ", e);
                                }
                            })

                        }), function (e) {
                            $("#mainSection").dimmer("hide");
                            console.log("ERROR in catch: ", e);
                        }
                    });

                }), function (error) {
                    console.log("ERROR: ", error);
                };
            }
        }).render('#paypal-button-container');

    </script>
    <script>
        $("#home, #cancel, #cancel2, #cancel3").click(function () {
            /* function goes in here */
            location.reload()
        });
    </script>
</body>

</html>